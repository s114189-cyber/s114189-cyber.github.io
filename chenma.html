<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>åˆæˆæ°´æœéŠæˆ²ï¼ˆ12çƒ+å †ç–Š+åˆ†æ•¸ï¼‰</title>
<style>
body{
  margin:0;
  background:#f2e8c9;
  display:flex;
  flex-direction:column;
  align-items:center;
  font-family:sans-serif;
  user-select:none;
  touch-action:none;
}
#container{
  position:relative;
  margin-top:20px;
  margin-bottom:50px;
}
canvas{
  background:#fffbe6;
  border:3px solid #444;
  display:block;
  touch-action:none;
}
#startScreen{
  position:absolute;
  inset:0;
  background:rgba(255,255,255,0.95);
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:24px;
  z-index:10;
}
button{
  position:absolute;
  top:10px;
  right:10px;
  z-index:5;
}
</style>
</head>
<body>
<div id="container">
  <canvas id="game" width="360" height="600"></canvas>
  <div id="startScreen">é»æ“Šé–‹å§‹éŠæˆ² ğŸ‰</div>
  <button onclick="restart()">é‡æ–°é–‹å§‹</button>
</div>
<script>
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const startScreen=document.getElementById("startScreen");
const GRAVITY=0.4,MAX_VY=9,RED_LINE=60;

let gameStarted=false,gameOver=false,canDrop=true,dropX=canvas.width/2;
let score=0,highScore=localStorage.getItem("melonHighScore")||0;

// 12çƒï¼Œå½©è™¹é †åº
const fruits=[
  {r:28,color:"#ff0000",score:10},
  {r:30,color:"#ff7f00",score:20},
  {r:32,color:"#ffff00",score:40},
  {r:34,color:"#7fff00",score:80},
  {r:36,color:"#00ff00",score:160},
  {r:38,color:"#00ff7f",score:320},
  {r:40,color:"#00ffff",score:640},
  {r:42,color:"#007fff",score:1280},
  {r:44,color:"#0000ff",score:2560},
  {r:46,color:"#7f00ff",score:5120},
  {r:48,color:"#ff00ff",score:10240},
  {r:50,color:"#ff007f",score:20480}
];

// è¨­å®šæ©«å‘æ ¼å­æ•¸é‡
const GRID_W = 12; 
const gridSpacing = canvas.width / GRID_W;

class Ball{
  constructor(x,y,type){
    this.x=x; this.y=y; this.vy=0; this.type=type; this.settled=false;
  }
  get r(){return fruits[this.type].r;}

  update(){
    if(this.settled) return;
    this.vy=Math.min(this.vy+GRAVITY,MAX_VY);
    this.y+=this.vy;

    // å¾€ä¸‹æ‰¾ç¢°æ’
    for(const other of balls){
      if(other===this||!other.settled) continue;
      const dx=this.x-other.x;
      const dy=this.y-other.y;
      const dist=Math.hypot(dx,dy);
      const minDist=this.r+other.r;
      if(dist<minDist){
        this.y = other.y - minDist + 1;
        this.vy=0;
        this.settled=true;
      }
    }
    // ç¢°åˆ°åº•
    if(this.y+this.r>=canvas.height){
      this.y=canvas.height-this.r;
      this.vy=0;
      this.settled=true;
    }

    // æ©«å‘é‚Šç•Œ
    this.x=clamp(this.x,this.r,canvas.width-this.r);
  }

  draw(){
    const f=fruits[this.type];
    ctx.beginPath();
    ctx.arc(this.x,this.y,f.r,0,Math.PI*2);
    ctx.fillStyle=f.color;
    ctx.fill();
  }
}

let balls=[];
let nextFruit=Math.floor(Math.random()*3);

// é–‹å§‹éŠæˆ²
startScreen.onclick=()=>{gameStarted=true;startScreen.style.display="none";}

// æ§åˆ¶
function movePreview(clientX){
  const rect=canvas.getBoundingClientRect();
  const r=fruits[nextFruit].r;
  dropX=clamp(clientX-rect.left,r,canvas.width-r);
}
canvas.addEventListener("mousemove",e=>{if(gameStarted) movePreview(e.clientX);});
canvas.addEventListener("click",()=>{if(gameStarted && !gameOver && canDrop) drop();});
let moved=false;
canvas.addEventListener("touchstart",e=>{if(!gameStarted||gameOver)return;moved=false;},{passive:false});
canvas.addEventListener("touchmove",e=>{if(!gameStarted)return;e.preventDefault();moved=true;movePreview(e.touches[0].clientX);},{passive:false});
canvas.addEventListener("touchend",e=>{if(!gameStarted||gameOver)return;if(!moved&&canDrop)drop();},{passive:false});

// æ‰è½çƒ
function drop(){
  if(!canDrop) return;
  canDrop=false;
  // å°é½Šæ ¼å­ä¸­å¿ƒ
  const gridX = Math.round(dropX/gridSpacing)*gridSpacing;
  balls.push(new Ball(gridX, RED_LINE+60, nextFruit));
  nextFruit=Math.floor(Math.random()*3);
  setTimeout(()=>canDrop=true,400);
}

// ç¢°æ’ä¿®æ­£
function fixOverlap(){
  for(let i=0;i<balls.length;i++){
    for(let j=i+1;j<balls.length;j++){
      const a=balls[i],b=balls[j];
      const dx=b.x-a.x,dy=b.y-a.y;
      const d=Math.hypot(dx,dy);
      const min=a.r+b.r;
      if(d<min&&d>0){
        const nx=dx/d,ny=dy/d,o=(min-d)/2;
        a.x-=nx*o; b.x+=nx*o;
        a.x=clamp(a.x,a.r,canvas.width-a.r);
        b.x=clamp(b.x,b.r,canvas.width-b.r);
      }
    }
  }
}

// åˆæˆ
function merge(){
  for(let i=0;i<balls.length;i++){
    for(let j=i+1;j<balls.length;j++){
      const a=balls[i],b=balls[j];
      if(a.type===b.type && Math.hypot(a.x-b.x,a.y-b.y)<a.r+b.r){
        const nx=(a.x+b.x)/2;
        const ny=(a.y+b.y)/2;
        const nt=a.type+1;
        score+=fruits[a.type].score;
        if(score>highScore){highScore=score;localStorage.setItem("melonHighScore",highScore);}
        balls.splice(j,1); balls.splice(i,1);
        if(nt<fruits.length){
          balls.push(new Ball(clamp(nx,fruits[nt].r,canvas.width-fruits[nt].r), ny, nt));
        }
        return;
      }
    }
  }
}

// Game Over
function checkGameOver(){
  for(const b of balls){
    if(b.settled && b.y-b.r<RED_LINE){
      gameOver=true;
      if(score>highScore){highScore=score;localStorage.setItem("melonHighScore",highScore);}
      return;
    }
  }
}

// ä¸»è¿´åœˆ
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // ç•«ç´…ç·š
  ctx.strokeStyle="red";
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(0,RED_LINE);
  ctx.lineTo(canvas.width,RED_LINE);
  ctx.stroke();

  balls.forEach(b=>{b.update();b.draw();});
  for(let i=0;i<3;i++) fixOverlap();
  merge();
  checkGameOver();

  // åˆ†æ•¸
  ctx.fillStyle="#000";
  ctx.font="18px sans-serif";
  ctx.fillText("åˆ†æ•¸: "+score,10,20);
  ctx.fillText("æœ€é«˜åˆ†: "+highScore,10,45);

  // åˆæˆé †åºè¡¨ (Canvas ä¸‹æ–¹ï¼Œ2~3æ’)
  ctx.font="14px sans-serif";
  let x=10,y=canvas.height-80;
  for(let i=0;i<fruits.length;i++){
    ctx.fillStyle=fruits[i].color;
    ctx.beginPath();
    ctx.arc(x+fruits[i].r,y+fruits[i].r,fruits[i].r,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="#000";
    ctx.fillText(i+1,x+fruits[i].r-4,y+fruits[i].r*2+2);
    x+=fruits[i].r*2+4;
    if(x>canvas.width-30){x=10;y+=fruits[i].r*2+10;}
  }

  if(gameOver){
    ctx.fillStyle="#000";
    ctx.font="28px sans-serif";
    ctx.fillText("Game Over",110,300);
  }

  requestAnimationFrame(loop);
}
loop();

// é‡æ–°é–‹å§‹
function restart(){
  balls=[];
  score=0;
  gameOver=false;
  nextFruit=Math.floor(Math.random()*3);
}
</script>
</body>
</html>
