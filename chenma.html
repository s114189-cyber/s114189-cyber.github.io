<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>åˆæˆæ°´æœéŠæˆ²ï¼ˆæ»‘å‹•æ§åˆ¶æœ€çµ‚ç‰ˆï¼‰</title>

<style>
body{
  margin:0;
  background:#f2e8c9;
  display:flex;
  flex-direction:column;
  align-items:center;
  font-family:sans-serif;
  user-select:none;
  touch-action:none;
}

#container{
  position:relative;
  margin-top:20px;
  margin-bottom:50px;
}

canvas{
  background:#fffbe6;
  border:3px solid #444;
  display:block;
  touch-action:none;
}

#startScreen{
  position:absolute;
  inset:0;
  background:rgba(255,255,255,0.95);
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:24px;
  z-index:10;
}

button{
  position:absolute;
  top:10px;
  right:10px;
  z-index:5;
}

#sequenceTitle{
  margin-top:30px;
  font-size:14px;
}

#fruitSequence{
  margin-top:12px;
  display:flex;
  align-items:flex-end;
  height:80px;
}

.fruit-icon{
  width:50px;
  text-align:center;
  font-size:12px;
  margin:0 5px;
}

.circle{
  border-radius:50%;
  margin:auto;
}
</style>
</head>

<body>

<div id="container">
  <canvas id="game" width="360" height="600"></canvas>
  <div id="startScreen">é»æ“Šé–‹å§‹éŠæˆ² ğŸ‰</div>
  <button onclick="restart()">é‡æ–°é–‹å§‹</button>
</div>

<div id="sequenceTitle">åˆæˆé †åº</div>
<div id="fruitSequence"></div>

<script>
/* ===== å·¥å…· ===== */
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

/* ===== åŸºæœ¬è¨­å®š ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const startScreen = document.getElementById("startScreen");

const GRAVITY = 0.35;
const MAX_VY = 8;
const RED_LINE = 60;

let gameStarted=false;
let gameOver=false;
let score=0;
let dropX=canvas.width/2;
let canDrop=true;

/* ===== æ°´æœ ===== */
const fruits=[
  {r:22,color:"#ff7676",score:10},
  {r:26,color:"#ff9f43",score:20},
  {r:30,color:"#feca57",score:40},
  {r:34,color:"#1dd1a1",score:80},
  {r:38,color:"#48dbfb",score:160},
  {r:44,color:"#5f27cd",score:320}
];

/* ===== çƒ ===== */
class Ball{
  constructor(x,y,type){
    this.x=x;
    this.y=y;
    this.vy=0;
    this.type=type;
    this.settled=false;
  }
  get r(){return fruits[this.type].r;}

  update(){
    if(!this.settled){
      this.vy+=GRAVITY;
      this.vy=Math.min(this.vy,MAX_VY);
      this.y+=this.vy;
    }

    // å·¦å³é‚Šç•Œï¼ˆâ˜…é‡é»ï¼‰
    this.x = clamp(this.x, this.r, canvas.width - this.r);

    if(this.y+this.r>=canvas.height){
      this.y=canvas.height-this.r;
      this.vy=0;
      this.settled=true;
    }
  }

  draw(){
    const f=fruits[this.type];
    ctx.beginPath();
    ctx.arc(this.x,this.y,f.r,0,Math.PI*2);
    ctx.fillStyle=f.color;
    ctx.fill();
  }
}

let balls=[];
let nextFruit=Math.floor(Math.random()*3);

/* ===== é–‹å§‹ ===== */
startScreen.onclick=()=>{
  gameStarted=true;
  startScreen.style.display="none";
};

/* ===== æ§åˆ¶ï¼ˆåªç§»å‹•ã€ä¸æ‰è½ï¼‰ ===== */
function movePreview(clientX){
  const rect=canvas.getBoundingClientRect();
  const r=fruits[nextFruit].r;
  dropX = clamp(clientX - rect.left, r, canvas.width - r);
}

/* é›»è…¦ */
canvas.addEventListener("mousemove",e=>{
  if(gameStarted) movePreview(e.clientX);
});

canvas.addEventListener("click",()=>{
  if(gameStarted && canDrop && !gameOver) drop();
});

/* æ‰‹æ©Ÿ */
canvas.addEventListener("touchmove",e=>{
  if(!gameStarted) return;
  e.preventDefault();
  movePreview(e.touches[0].clientX);
},{passive:false});

canvas.addEventListener("touchstart",e=>{
  if(!gameStarted||!canDrop||gameOver) return;
  e.preventDefault();
  drop();
},{passive:false});

/* ===== æ‰è½ ===== */
function drop(){
  canDrop=false;
  balls.push(new Ball(dropX,RED_LINE+40,nextFruit));
  nextFruit=Math.floor(Math.random()*3);
  setTimeout(()=>canDrop=true,400);
}

/* ===== ç¢°æ’ä¿®æ­£ ===== */
function fixOverlap(){
  for(let i=0;i<balls.length;i++){
    for(let j=i+1;j<balls.length;j++){
      const a=balls[i],b=balls[j];
      const dx=b.x-a.x,dy=b.y-a.y;
      const d=Math.hypot(dx,dy);
      const min=a.r+b.r;
      if(d<min&&d>0){
        const nx=dx/d,ny=dy/d,o=(min-d)/2;
        a.x-=nx*o; b.x+=nx*o;
        a.x=clamp(a.x,a.r,canvas.width-a.r);
        b.x=clamp(b.x,b.r,canvas.width-b.r);
      }
    }
  }
}

/* ===== åˆæˆ ===== */
function merge(){
  for(let i=0;i<balls.length;i++){
    for(let j=i+1;j<balls.length;j++){
      const a=balls[i],b=balls[j];
      if(a.type===b.type&&Math.hypot(a.x-b.x,a.y-b.y)<a.r+b.r){
        const nx=(a.x+b.x)/2,ny=(a.y+b.y)/2;
        const nt=a.type+1;
        balls.splice(j,1);balls.splice(i,1);
        if(nt<fruits.length){
          balls.push(new Ball(
            clamp(nx,fruits[nt].r,canvas.width-fruits[nt].r),
            ny,nt
          ));
        }
        score+=fruits[a.type].score;
        return;
      }
    }
  }
}

/* ===== Game Over ===== */
function checkGameOver(){
  for(const b of balls){
    if(b.settled&&b.y-b.r<RED_LINE){
      gameOver=true;
      return;
    }
  }
}

/* ===== UI ===== */
function drawUI(){
  ctx.fillStyle="#000";
  ctx.fillText("åˆ†æ•¸ï¼š"+score,10,20);

  ctx.setLineDash([6,6]);
  ctx.strokeStyle="red";
  ctx.beginPath();
  ctx.moveTo(0,RED_LINE);
  ctx.lineTo(canvas.width,RED_LINE);
  ctx.stroke();
  ctx.setLineDash([]);

  const f=fruits[nextFruit];
  ctx.beginPath();
  ctx.arc(dropX,RED_LINE+40,f.r,0,Math.PI*2);
  ctx.fillStyle=f.color;
  ctx.fill();
}

/* ===== åˆæˆé †åº ===== */
const seq=document.getElementById("fruitSequence");
fruits.forEach((f,i)=>{
  const d=document.createElement("div");
  d.className="fruit-icon";
  const c=document.createElement("div");
  c.className="circle";
  c.style.width=c.style.height=f.r*2+"px";
  c.style.background=f.color;
  d.appendChild(c);
  const t=document.createElement("div");
  t.textContent=i+1;
  d.appendChild(t);
  seq.appendChild(d);
});

/* ===== é‡æ–°é–‹å§‹ ===== */
function restart(){
  balls=[];score=0;gameOver=false;
}

/* ===== ä¸»è¿´åœˆ ===== */
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  balls.forEach(b=>{b.update();b.draw();});
  for(let i=0;i<3;i++) fixOverlap();
  merge();
  drawUI();
  checkGameOver();
  if(gameOver) ctx.fillText("Game Over",130,300);
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
