<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>åˆæˆæ°´æœéŠæˆ²ï¼ˆ12çƒ+å †ç–Š+é è¦½+åˆ†æ•¸ï¼‰</title>
<style>
body{
  margin:0;
  background:#f2e8c9;
  display:flex;
  flex-direction:column;
  align-items:center;
  font-family:sans-serif;
  user-select:none;
  touch-action:none;
}
#container{
  position:relative;
  margin-top:20px;
}
canvas{
  background:#fffbe6;
  border:3px solid #444;
  display:block;
  touch-action:none;
}
#startScreen{
  position:absolute;
  inset:0;
  background:rgba(255,255,255,0.95);
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:24px;
  z-index:10;
}
button{
  position:absolute;
  top:10px;
  right:10px;
  z-index:5;
}
#scoreBoard{
  margin-top:10px;
  text-align:left;
  width:360px;
}
#orderTable{
  margin-top:10px;
  width:360px;
  display:flex;
  flex-wrap:wrap;
  justify-content:flex-start;
  gap:4px;
}
.orderBall{
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  color:#000;
  font-weight:bold;
}
</style>
</head>
<body>
<div id="container">
  <canvas id="game" width="360" height="600"></canvas>
  <div id="startScreen">é»æ“Šé–‹å§‹éŠæˆ² ğŸ‰</div>
  <button onclick="restart()">é‡æ–°é–‹å§‹</button>
</div>
<div id="scoreBoard">
  <div id="scoreText">åˆ†æ•¸: 0 &nbsp;&nbsp;æœ€é«˜åˆ†: 0</div>
</div>
<div id="orderTable"></div>

<script>
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const startScreen=document.getElementById("startScreen");
const scoreText=document.getElementById("scoreText");
const orderTable=document.getElementById("orderTable");

const GRAVITY=0.5, MAX_VY=12, RED_LINE=60;
let gameStarted=false, gameOver=false, canDrop=true;
let dropX=180, score=0, highScore=localStorage.getItem("melonHighScore")||0;

// 12çƒï¼Œå°å°ºå¯¸ï¼Œå½©è™¹é †åº
const fruits=[
  {r:16,color:"#ff0000",score:10},
  {r:20,color:"#ff7f00",score:20},
  {r:24,color:"#ffff00",score:40},
  {r:28,color:"#7fff00",score:80},
  {r:32,color:"#00ff00",score:160},
  {r:36,color:"#00ff7f",score:320},
  {r:40,color:"#00ffff",score:640},
  {r:44,color:"#007fff",score:1280},
  {r:48,color:"#0000ff",score:2560},
  {r:52,color:"#7f00ff",score:5120},
  {r:56,color:"#ff00ff",score:10240},
  {r:60,color:"#ff007f",score:20480}
];

const GRID_W=12;
const gridSpacing=canvas.width/GRID_W;

class Ball{
  constructor(x,y,type){
    this.x=x; this.y=y; this.vy=0; this.type=type; this.settled=false;
  }
  get r(){return fruits[this.type].r;}
  update(){
    if(this.settled) return;

    this.vy=Math.min(this.vy+GRAVITY, MAX_VY);
    this.y+=this.vy;

    // æ©«å‘æ ¼å­å°é½Š
    this.x=Math.round(this.x/gridSpacing)*gridSpacing;
    
    // æª¢æŸ¥æ©«å‘å †ç–Šï¼ˆåªçœ‹åŒåˆ—æ ¼å­ï¼‰
    let maxY=canvas.height-this.r;
    for(const other of balls){
      if(other===this || !other.settled) continue;
      if(Math.abs(other.x-this.x)<gridSpacing/2){
        maxY=Math.min(maxY, other.y-this.r-other.r);
      }
    }
    if(this.y>maxY){
      this.y=maxY;
      this.vy=0;
      this.settled=true;
    }
  }
  draw(){
    const f=fruits[this.type];
    ctx.beginPath();
    ctx.arc(this.x,this.y,f.r,0,Math.PI*2);
    ctx.fillStyle=f.color;
    ctx.fill();
    ctx.strokeStyle="#000";
    ctx.stroke();
  }
}

let balls=[];
let nextFruit=Math.floor(Math.random()*3);

// é–‹å§‹
startScreen.onclick=()=>{gameStarted=true;startScreen.style.display="none";}

// æ»‘å‹•æ§åˆ¶
function movePreview(clientX){
  const rect=canvas.getBoundingClientRect();
  dropX=clamp(clientX-rect.left,fruits[nextFruit].r,canvas.width-fruits[nextFruit].r);
}

// é›»è…¦äº‹ä»¶
canvas.addEventListener("mousemove",e=>{if(gameStarted) movePreview(e.clientX);});
canvas.addEventListener("click",()=>{if(gameStarted && !gameOver && canDrop) drop();});

// æ‰‹æ©Ÿæ»‘å‹•
let moved=false;
canvas.addEventListener("touchstart",e=>{if(!gameStarted||gameOver)return;moved=false;},{passive:false});
canvas.addEventListener("touchmove",e=>{
  if(!gameStarted) return;
  e.preventDefault();
  moved=true;
  movePreview(e.touches[0].clientX);
},{passive:false});
canvas.addEventListener("touchend",e=>{
  if(!gameStarted||gameOver) return;
  if(!moved && canDrop) drop();
},{passive:false});

// æ‰è½
function drop(){
  if(!canDrop) return;
  canDrop=false;
  balls.push(new Ball(dropX, RED_LINE+60, nextFruit));
  nextFruit=Math.floor(Math.random()*3);
  setTimeout(()=>canDrop=true,200);
}

// åˆæˆ
function merge(){
  for(let i=0;i<balls.length;i++){
    for(let j=i+1;j<balls.length;j++){
      const a=balls[i],b=balls[j];
      const dist=Math.hypot(a.x-b.x,a.y-b.y);
      if(a.type===b.type && dist<a.r+b.r){
        const nx=(a.x+b.x)/2;
        const ny=(a.y+b.y)/2;
        const nt=a.type+1;
        score+=fruits[a.type].score;
        if(score>highScore){highScore=score;localStorage.setItem("melonHighScore",highScore);}
        balls.splice(j,1); balls.splice(i,1);
        if(nt<fruits.length){
          balls.push(new Ball(nx, ny, nt));
        }
        return;
      }
    }
  }
}

// Game Over
function checkGameOver(){
  for(const b of balls){
    if(b.settled && b.y-b.r<RED_LINE){
      gameOver=true;
      if(score>highScore){highScore=score;localStorage.setItem("melonHighScore",highScore);}
      return;
    }
  }
}

// é¡¯ç¤ºåˆæˆé †åºè¡¨
function drawOrderTable(){
  orderTable.innerHTML="";
  for(let i=0;i<fruits.length;i++){
    const div=document.createElement("div");
    div.className="orderBall";
    div.style.width="24px";
    div.style.height="24px";
    div.style.backgroundColor=fruits[i].color;
    div.textContent=i+1;
    orderTable.appendChild(div);
  }
}

// ä¸»è¿´åœˆ
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // ç´…ç·š
  ctx.strokeStyle="red";
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(0,RED_LINE);
  ctx.lineTo(canvas.width,RED_LINE);
  ctx.stroke();

  // çƒæ›´æ–°èˆ‡ç¹ªè£½
  balls.forEach(b=>{b.update();b.draw();});
  merge();
  checkGameOver();

  // ä¸‹ä¸€é¡†çƒé è¦½
  const pf=fruits[nextFruit];
  ctx.beginPath();
  ctx.arc(canvas.width-40,RED_LINE/2,pf.r,0,Math.PI*2);
  ctx.fillStyle=pf.color;
  ctx.fill();
  ctx.strokeStyle="#000";
  ctx.stroke();

  // åˆ†æ•¸
  scoreText.innerHTML=`åˆ†æ•¸: ${score} &nbsp;&nbsp;æœ€é«˜åˆ†: ${highScore}`;

  // åˆæˆé †åºè¡¨
  drawOrderTable();

  // Game Over
  if(gameOver){
    ctx.fillStyle="#000";
    ctx.font="28px sans-serif";
    ctx.fillText("Game Over",110,300);
  }

  requestAnimationFrame(loop);
}
loop();

// é‡æ–°é–‹å§‹
function restart(){
  balls=[]; score=0; gameOver=false; nextFruit=Math.floor(Math.random()*3);
}
</script>
</body>
</html>
