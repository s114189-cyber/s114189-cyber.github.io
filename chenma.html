<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>åˆæˆæ°´æœéŠæˆ²</title>
<style>
  body {
    margin: 0;
    background: #f2e8c9;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: sans-serif;
    user-select: none;
  }
  #container { position: relative; margin-top: 20px; }
  canvas {
    background: #fffbe6;
    border: 3px solid #444;
    touch-action: none;
    display: block;
  }
  #startScreen {
    position: absolute;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    top: 0;
    left: 0;
    z-index: 20;
    font-size: 24px;
    cursor: pointer;
  }
  #fruitSequence {
    margin-top: 10px; /* é»‘æ¡†å¤– */
    display: flex;
    justify-content: center;
    align-items: flex-end;
    height: 60px;
  }
  .fruit-icon {
    width: 50px;
    text-align: center;
    margin: 0 5px;
    font-size: 12px;
  }
  .fruit-circle {
    border-radius: 50%;
    display: block;
    margin: 0 auto 2px auto;
    height: 100%;
    width: 100%;
  }
  button {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
  }
</style>
</head>
<body>

<div id="container">
  <canvas id="game" width="360" height="600"></canvas>
  <div id="startScreen">é»æ“Šé–‹å§‹éŠæˆ² ğŸ‰</div>
  <button onclick="restartConfirm()">é‡æ–°é–‹å§‹</button>
</div>

<div id="fruitSequence"></div> <!-- é»‘æ¡†å¤– -->

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const startScreen = document.getElementById("startScreen");
const fruitSequenceDiv = document.getElementById("fruitSequence");

const GRAVITY = 0.35;
const RED_LINE = 60;

let score = 0;
let highScore = localStorage.getItem("highScore") || 0;
let gameOver = false;
let gameStarted = false;
let dropX = canvas.width / 2;

const fruits = [
  { r: 22, color: "#ff7676", score: 10 },
  { r: 26, color: "#ff9f43", score: 20 },
  { r: 30, color: "#feca57", score: 40 },
  { r: 34, color: "#1dd1a1", score: 80 },
  { r: 38, color: "#48dbfb", score: 160 },
  { r: 44, color: "#5f27cd", score: 320 },
  { r: 50, color: "#2ecc71", score: 640 },
  { r: 60, color: "#27ae60", score: 1280 }
];

class Ball {
  constructor(x, y, type) {
    this.x = x;
    this.y = y;
    this.vy = 0;
    this.type = type;
  }
  get r() { return fruits[this.type].r; }
  update() {
    this.vy += GRAVITY;
    this.y += this.vy;
    this.x = Math.max(this.r, Math.min(canvas.width - this.r, this.x));
    if (this.y + this.r > canvas.height) {
      this.y = canvas.height - this.r;
      this.vy *= -0.2;
    }
  }
  draw() {
    const f = fruits[this.type];
    ctx.beginPath();
    ctx.arc(this.x, this.y, f.r, 0, Math.PI * 2);
    ctx.fillStyle = f.color;
    ctx.fill();
    // è‡‰
    ctx.fillStyle = "#000";
    ctx.beginPath();
    ctx.arc(this.x - f.r/4, this.y - f.r/6, 2, 0, Math.PI*2);
    ctx.arc(this.x + f.r/4, this.y - f.r/6, 2, 0, Math.PI*2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(this.x, this.y + f.r/6, f.r/5, 0, Math.PI);
    ctx.stroke();
  }
}

let balls = [];
let nextFruit = Math.floor(Math.random() * 3);

/* ===== é–‹å§‹ç•«é¢ ===== */
startScreen.addEventListener("click", () => {
  startScreen.style.display = "none";
  gameStarted = true;
});

/* ===== æ“ä½œäº‹ä»¶ ===== */
function moveDropX(clientX){
  const r = canvas.getBoundingClientRect();
  dropX = clientX - r.left;
  dropX = Math.max(fruits[nextFruit].r, Math.min(canvas.width - fruits[nextFruit].r, dropX));
}
canvas.addEventListener("mousemove", e => { if(gameStarted) moveDropX(e.clientX); });
canvas.addEventListener("touchmove", e => { 
  if(!gameStarted) return;
  e.preventDefault();
  moveDropX(e.touches[0].clientX);
},{passive:false});

// é»æ“Š/è§¸ç¢°æ‰çƒ
function dropFruit(){
  if(gameOver) return;
  balls.push(new Ball(dropX, RED_LINE + 25, nextFruit));
  nextFruit = Math.floor(Math.random() * 3);
}
canvas.addEventListener("click", e => { if(gameStarted) dropFruit(); });
canvas.addEventListener("touchstart", e => { 
  if(!gameStarted) return;
  e.preventDefault();
  dropFruit();
},{passive:false});

/* ===== ç¢°æ’èˆ‡åˆæˆ ===== */
function resolveOverlap() {
  for(let i=0;i<balls.length;i++){
    for(let j=i+1;j<balls.length;j++){
      const a=balls[i], b=balls[j];
      const dx=b.x-a.x, dy=b.y-a.y;
      const dist=Math.hypot(dx,dy);
      const minDist=a.r+b.r;
      if(dist<minDist && dist>0){
        const overlap=(minDist-dist)/2;
        const nx=dx/dist, ny=dy/dist;
        a.x-=nx*overlap; a.y-=ny*overlap;
        b.x+=nx*overlap; b.y+=ny*overlap;
      }
    }
  }
}

function collide(a,b){ return Math.hypot(a.x-b.x,a.y-b.y)<a.r+b.r; }

function merge(){
  for(let i=0;i<balls.length;i++){
    for(let j=i+1;j<balls.length;j++){
      if(balls[i].type===balls[j].type && collide(balls[i],balls[j])){
        score+=fruits[balls[i].type].score;
        if(score>highScore){ highScore=score; localStorage.setItem("highScore",highScore);}
        const nx=(balls[i].x+balls[j].x)/2;
        const ny=(balls[i].y+balls[j].y)/2;
        const nt=balls[i].type+1;
        balls.splice(j,1); balls.splice(i,1);
        if(nt<fruits.length) balls.push(new Ball(nx,ny,nt));
        return;
      }
    }
  }
}

// æ­»äº¡åˆ¤å®šï¼šæœ€é«˜çƒç–Šåˆ°ç´…ç·š
function checkGameOver(){
  if(balls.length===0) return;
  const topBall = Math.min(...balls.map(b=>b.y - b.r));
  if(topBall < RED_LINE) gameOver = true;
}

/* ===== UI ===== */
function drawUI(){
  ctx.fillStyle="#000";
  ctx.fillText("åˆ†æ•¸ï¼š"+score,10,20);
  ctx.fillText("æœ€é«˜åˆ†ï¼š"+highScore,10,40);

  // ç´…ç·š
  ctx.setLineDash([6,6]);
  ctx.strokeStyle="red";
  ctx.beginPath();
  ctx.moveTo(0,RED_LINE);
  ctx.lineTo(canvas.width,RED_LINE);
  ctx.stroke();
  ctx.setLineDash([]);

  // é è¦½çƒï¼ˆå…¨éƒ¨é¡è‰²éƒ½åœ¨ç´…ç·šä¸‹æ–¹ï¼‰
  const f=fruits[nextFruit];
  const previewY = RED_LINE + 25 + f.r; // ç¢ºä¿çƒåº•éƒ¨åœ¨ç´…ç·šä¸‹
  ctx.beginPath();
  ctx.arc(dropX, previewY, f.r,0,Math.PI*2);
  ctx.fillStyle=f.color;
  ctx.fill();
}

/* ===== æ°´æœåˆæˆé †åºåœ– ===== */
function drawFruitSequence(){
  fruitSequenceDiv.innerHTML = '';
  fruits.forEach((f,i)=>{
    const div = document.createElement('div');
    div.className = 'fruit-icon';
    const circle = document.createElement('div');
    circle.className = 'fruit-circle';
    circle.style.background = f.color;
    circle.style.width = f.r*2+'px';
    circle.style.height = f.r*2+'px';
    div.appendChild(circle);
    const label = document.createElement('div');
    label.textContent = i+1;
    div.appendChild(label);
    fruitSequenceDiv.appendChild(div);
  });
}
drawFruitSequence();

/* ===== é‡æ–°é–‹å§‹ ===== */
function restartConfirm(){
  if(confirm("ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿ")){
    balls=[]; score=0; gameOver=false; gameStarted=true;
    startScreen.style.display = "none";
  }
}

/* ===== éŠæˆ²å¾ªç’° ===== */
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  balls.forEach(b=>{b.update();b.draw();});
  resolveOverlap();
  merge();
  drawUI();
  checkGameOver();
  if(gameOver) ctx.fillText("Game Over",120,300);
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>

